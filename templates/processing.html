{% extends "base.html" %}

{% block title %}Creating Your Travel Plan - GlobePiloT{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Processing Status -->
        <div class="card">
            <div class="card-header text-center">
                <h2><i class="fas fa-magic me-3"></i>Creating Your Travel Plan
                    {% if request_details.get('revision') %}
                    <span class="badge bg-warning ms-2">
                        <i class="fas fa-sync-alt me-1"></i>Revision
                    </span>
                    {% endif %}
                </h2>
                <p class="mb-0 opacity-90">
                    {% if request_details.get('revision') %}
                    Our AI agents are revising your travel plan with updated requirements
                    {% else %}
                    Our AI agents are working hard to create your perfect itinerary
                    {% endif %}
                </p>
            </div>
            <div class="card-body p-4">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar">
                        </div>
                    </div>
                    <div class="text-center">
                        <h5 id="statusText" class="text-primary">Initializing AI agents...</h5>
                        <p id="statusDetail" class="text-muted">Getting ready to start your travel planning</p>
                    </div>
                </div>
                
                <!-- AI Agents Status -->
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3"><i class="fas fa-robot me-2"></i>Planning Agents</h6>
                        <div class="agent-status" id="agents-planning">
                            <div class="d-flex align-items-center mb-2" id="agent-general">
                                <i class="fas fa-circle text-muted me-2" id="icon-general"></i>
                                <span>General Research Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-accommodations">
                                <i class="fas fa-circle text-muted me-2" id="icon-accommodations"></i>
                                <span>Accommodations Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-activities">
                                <i class="fas fa-circle text-muted me-2" id="icon-activities"></i>
                                <span>Activities Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-events">
                                <i class="fas fa-circle text-muted me-2" id="icon-events"></i>
                                <span>Local Events Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-budget">
                                <i class="fas fa-circle text-muted me-2" id="icon-budget"></i>
                                <span>Budget Analysis Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-flight">
                                <i class="fas fa-circle text-muted me-2" id="icon-flight"></i>
                                <span>Flight Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-transport">
                                <i class="fas fa-circle text-muted me-2" id="icon-transport"></i>
                                <span>Local Transportation Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-weather">
                                <i class="fas fa-circle text-muted me-2" id="icon-weather"></i>
                                <span>Weather Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-planner">
                                <i class="fas fa-circle text-muted me-2" id="icon-planner"></i>
                                <span>Travel Planner Agent</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3"><i class="fas fa-shield-alt me-2"></i>Validation Agents</h6>
                        <div class="agent-status" id="agents-validation">
                            <div class="d-flex align-items-center mb-2" id="agent-validation">
                                <i class="fas fa-circle text-muted me-2" id="icon-validation"></i>
                                <span>Validation Agent</span>
                            </div>
                            <div class="d-flex align-items-center mb-2" id="agent-quality">
                                <i class="fas fa-circle text-muted me-2" id="icon-quality"></i>
                                <span>Quality Control Agent</span>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="text-success mb-3"><i class="fas fa-check-circle me-2"></i>Validation Features</h6>
                            <ul class="list-unstyled text-sm">
                                <li><i class="fas fa-check text-success me-2"></i>Budget compliance checking</li>
                                <li><i class="fas fa-check text-success me-2"></i>Requirements validation</li>
                                <li><i class="fas fa-check text-success me-2"></i>Quality control & revisions</li>
                                <li><i class="fas fa-check text-success me-2"></i>Final plan approval</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Processing Log -->
                <div class="mt-4">
                    <h6 class="text-primary mb-3"><i class="fas fa-list me-2"></i>Processing Log</h6>
                    <div id="processingLog" class="alert alert-light" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-muted">Waiting for processing to begin...</div>
                    </div>
                </div>
                
                <!-- Cancel Button -->
                <div class="text-center mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Start Over
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Request Summary -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Your Travel Request</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-map-marker-alt me-2"></i>Route:</strong> 
                           {{ request_details.origin }} â†’ {{ request_details.destination }}</p>
                        <p><strong><i class="fas fa-calendar me-2"></i>Dates:</strong> 
                           {{ request_details.departure_date }} to {{ request_details.return_date }}</p>
                        <p><strong><i class="fas fa-users me-2"></i>Travelers:</strong> 
                           {{ request_details.travelers }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-dollar-sign me-2"></i>Budget:</strong> 
                           {{ request_details.budget_range }}</p>
                        <p><strong><i class="fas fa-suitcase me-2"></i>Trip Type:</strong> 
                           {{ request_details.trip_type|title }}</p>
                        <p><strong><i class="fas fa-clock me-2"></i>Requested:</strong> 
                           {{ request_details.timestamp }}</p>
                    </div>
                </div>
                {% if request_details.special_requirements %}
                <div class="mt-3">
                    <strong><i class="fas fa-list-ul me-2"></i>Special Requirements:</strong>
                    <div class="alert alert-info mt-2">{{ request_details.special_requirements }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let checkInterval;
let startTime = Date.now();
let currentStep = 0;

const steps = [
    'Initializing AI agents...',
    'General Research Agent working...',
    'Accommodations Agent working...',
    'Activities Agent working...',
    'Local Events Agent working...',
    'Budget Analysis Agent working...',
    'Flight Agent working...',
    'Local Transportation Agent working...',
    'Weather Agent working...',
    'Travel Planner Agent working...',
    'Validation Agent checking...',
    'Quality Control Agent reviewing...',
    'Finalizing your travel plan...'
];

const agentMapping = {
    'GeneralResearchAgent': 'general',
    'AccommodationsAgent': 'accommodations', 
    'ActivitiesAgent': 'activities',
    'LocalEventsAgent': 'events',
    'BudgetAnalysisAgent': 'budget',
    'FlightAgent': 'flight',
    'LocalTransportationAgent': 'transport',
    'WeatherAgent': 'weather',
    'TravelPlannerAgent': 'planner',
    'ValidationAgent': 'validation',
    'QualityControlAgent': 'quality'
};

function updateProgress(percentage, statusText, detail) {
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('statusText').textContent = statusText;
    document.getElementById('statusDetail').textContent = detail;
}

function activateAgent(agentName) {
    const agentKey = agentMapping[agentName];
    if (agentKey) {
        const icon = document.getElementById('icon-' + agentKey);
        if (icon) {
            icon.className = 'fas fa-circle text-warning me-2';
            icon.style.animation = 'pulse 1s infinite';
        }
    }
}

function completeAgent(agentName) {
    const agentKey = agentMapping[agentName];
    if (agentKey) {
        const icon = document.getElementById('icon-' + agentKey);
        if (icon) {
            icon.className = 'fas fa-check-circle text-success me-2';
            icon.style.animation = 'none';
        }
    }
}

function addLogEntry(message, type = 'info') {
    const log = document.getElementById('processingLog');
    const elapsed = Math.round((Date.now() - startTime) / 1000);
    const timestamp = new Date().toLocaleTimeString();
    
    const entry = document.createElement('div');
    entry.className = 'log-entry mb-1';
    entry.innerHTML = `
        <small class="text-muted">[${timestamp}]</small> 
        <span class="text-${type === 'error' ? 'danger' : 'primary'}">${message}</span>
    `;
    
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function checkStatus() {
    fetch('/status')
        .then(response => response.json())
        .then(data => {
            if (data.is_processing) {
                // Update progress based on time elapsed and status
                const elapsed = (Date.now() - startTime) / 1000;
                let progress = Math.min(90, elapsed * 2); // Rough progress based on time
                
                updateProgress(progress, data.progress || steps[currentStep], 
                             `Processing for ${Math.round(elapsed)} seconds...`);
                
                // Simulate agent activation based on progress
                if (progress > 10 && currentStep < 1) {
                    currentStep = 1;
                    activateAgent('GeneralResearchAgent');
                    addLogEntry('General Research Agent started');
                }
                if (progress > 25 && currentStep < 2) {
                    currentStep = 2;
                    completeAgent('GeneralResearchAgent');
                    activateAgent('AccommodationsAgent');
                    addLogEntry('Accommodations Agent started');
                }
                if (progress > 40 && currentStep < 3) {
                    currentStep = 3;
                    completeAgent('AccommodationsAgent');
                    activateAgent('ActivitiesAgent');
                    addLogEntry('Activities Agent started');
                }
                if (progress > 55 && currentStep < 4) {
                    currentStep = 4;
                    completeAgent('ActivitiesAgent');
                    activateAgent('LocalEventsAgent');
                    addLogEntry('Local Events Agent started');
                }
                if (progress > 65 && currentStep < 5) {
                    currentStep = 5;
                    completeAgent('LocalEventsAgent');
                    activateAgent('BudgetAnalysisAgent');
                    addLogEntry('Budget Analysis Agent started');
                }
                if (progress > 70 && currentStep < 6) {
                    currentStep = 6;
                    completeAgent('BudgetAnalysisAgent');
                    activateAgent('FlightAgent');
                    addLogEntry('Flight Agent started');
                }
                if (progress > 80 && currentStep < 7) {
                    currentStep = 7;
                    completeAgent('FlightAgent');
                    activateAgent('LocalTransportationAgent');
                    addLogEntry('Local Transportation Agent started');
                }
                if (progress > 90 && currentStep < 8) {
                    currentStep = 8;
                    completeAgent('LocalTransportationAgent');
                    activateAgent('WeatherAgent');
                    addLogEntry('Weather Agent started');
                }
                if (progress > 95 && currentStep < 9) {
                    currentStep = 9;
                    completeAgent('WeatherAgent');
                    activateAgent('TravelPlannerAgent');
                    addLogEntry('Travel Planner Agent started');
                }
                if (progress > 98 && currentStep < 10) {
                    currentStep = 10;
                    completeAgent('TravelPlannerAgent');
                    activateAgent('ValidationAgent');
                    addLogEntry('Validation Agent checking budget compliance');
                }
                if (progress > 99 && currentStep < 11) {
                    currentStep = 11;
                    completeAgent('ValidationAgent');
                    activateAgent('QualityControlAgent');
                    addLogEntry('Quality Control Agent reviewing plan');
                }
                
            } else {
                // Processing complete
                clearInterval(checkInterval);
                
                if (data.results) {
                    updateProgress(100, 'Complete!', 'Redirecting to your travel plan...');
                    addLogEntry('Travel plan created successfully!', 'success');
                    
                    // Mark all agents as complete
                    Object.values(agentMapping).forEach(agentKey => {
                        const icon = document.getElementById('icon-' + agentKey);
                        if (icon) {
                            icon.className = 'fas fa-check-circle text-success me-2';
                            icon.style.animation = 'none';
                        }
                    });
                    
                    // Redirect to results after a short delay
                    setTimeout(() => {
                        window.location.href = '/results';
                    }, 2000);
                } else {
                    updateProgress(100, 'Error occurred', data.progress || 'Please try again');
                    addLogEntry('Error: ' + (data.progress || 'Unknown error'), 'error');
                }
            }
        })
        .catch(error => {
            console.error('Status check failed:', error);
            addLogEntry('Status check failed: ' + error.message, 'error');
        });
}

// Start checking status every 2 seconds
document.addEventListener('DOMContentLoaded', function() {
    addLogEntry('Processing started');
    checkInterval = setInterval(checkStatus, 2000);
    checkStatus(); // Check immediately
});

// Add pulse animation
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %} 