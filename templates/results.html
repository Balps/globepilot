{% extends "base_results.html" %}

{% block title %}Your Travel Plan - GlobePiloT{% endblock %}

{% block content %}
<!-- Skip links for accessibility -->


<!-- Performance optimizations -->
{% for css_file in performance_hints().preload_css %}
<link rel="preload" href="{{ asset_url(css_file) }}" as="style">
{% endfor %}
{% for js_file in performance_hints().preload_js %}
<link rel="preload" href="{{ asset_url(js_file) }}" as="script">
{% endfor %}
{% for domain in performance_hints().dns_prefetch %}
<link rel="dns-prefetch" href="//{{ domain }}">
{% endfor %}
{% for url in performance_hints().preconnect %}
<link rel="preconnect" href="{{ url }}" crossorigin>
{% endfor %}

<!-- External CSS for better caching and performance -->
<link rel="stylesheet" href="{{ asset_url('css/variables.css') }}">
<link rel="stylesheet" href="{{ asset_url('css/results.css') }}">

<style>
        /* NYC Adventure Widget */
        .nyc-adventure-widget {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 2px solid #4f46e5;
            position: relative;
            margin-bottom: 2rem;
        }

        .widget-header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .widget-header::before {
            content: 'üóΩ';
            position: absolute;
            top: -50%;
            right: -10%;
            font-size: 200px;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }

        .widget-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .widget-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .trip-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            position: relative;
            z-index: 1;
        }

        .trip-stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: var(--transition-normal);
            cursor: pointer;
        }

        .trip-stat:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.3);
        }

        .trip-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .trip-stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }



        /* Widget Actions */
        .widget-actions {
            padding: 1.5rem;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .budget-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .budget-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#10b981 0deg 227deg, #e2e8f0 227deg 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .budget-circle::before {
            content: '';
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .budget-text {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .budget-amount {
            font-size: 0.875rem;
            font-weight: 700;
            color: #1e293b;
        }

        .budget-label {
            font-size: 0.75rem;
            color: #64748b;
        }

        .action-buttons {
            display: flex;
                gap: 1rem;
            flex-wrap: wrap;
        }

        /* Main Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .main-content {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Status Bar */
        .status-bar {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .progress-container {
            flex: 1;
            margin: 0 2rem;
            position: relative;
        }

        .progress-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: var(--primary-gradient);
            height: 100%;
            width: 85%;
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Enhanced Tab Navigation */
        .tab-navigation {
            display: flex;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            border-radius: 4px 4px 0 0;
            position: relative;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 1.25rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: inherit;
            border-radius: 2px 2px 0 0;
        }

        .tab-icon {
            font-size: 1.5rem;
            display: block;
            transition: transform 0.2s ease;
        }

        .tab-text {
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
        }

        .tab-btn.active {
            color: #4f46e5;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            border-radius: 2px 2px 0 0;
        }

        .tab-btn.active .tab-icon {
            transform: scale(1.1);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(79, 70, 229, 0.05);
            transform: translateY(-1px);
        }

        .tab-btn:hover .tab-icon {
            transform: scale(1.05);
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Search and Filters */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-bar {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .search-bar:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1), var(--shadow-md);
            transform: translateY(-1px);
        }

        .search-input {
            flex: 1;
            padding: 1rem 1rem 1rem 0.5rem;
            border: none;
            outline: none;
    font-size: 0.875rem;
            background: transparent;
            font-family: inherit;
            color: #1e293b;
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        .search-icon {
            padding: 0 1rem;
            color: #64748b;
            font-size: 1.25rem;
            transition: color 0.3s ease;
        }

        .search-bar:focus-within .search-icon {
            color: #4f46e5;
        }
        
        .search-filters {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 0.625rem 1.25rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .filter-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .filter-chip:hover::before {
            left: 100%;
        }

        .filter-chip:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #cbd5e1;
        }

        .filter-chip.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            transform: translateY(-1px);
        }

        .filter-chip.active:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
        }

        /* Enhanced Day Cards */
        .day-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .day-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 25%, #10b981 50%, #f59e0b 75%, #06b6d4 100%);
            transform: scaleX(0);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left;
        }
        
        .day-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .day-card:hover::before {
            transform: scaleX(1);
        }

        .day-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .day-card:hover::after {
            left: 100%;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        
        .day-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .day-number {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.125rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .day-number::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #10b981);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .day-card:hover .day-number::before {
            opacity: 1;
        }

        .day-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            font-size: 0.875rem;
            color: #64748b;
            min-width: 240px;
        }
         
        .day-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .day-stat:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: #6366f1;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .day-stat-icon {
            font-size: 1rem;
            opacity: 0.8;
        }

        .day-stat-value {
            font-weight: 600;
            color: #1e293b;
        }

        /* Enhanced Activity Timeline */
        .activity-timeline {
            position: relative;
            padding: 2rem 0;
        }

        .timeline-container {
            position: relative;
            padding-left: 4rem;
        }
        
        .timeline-spine {
            position: absolute;
            left: 2rem;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #e2e8f0 0%, #cbd5e1 50%, #e2e8f0 100%);
            border-radius: 2px;
        }

        .activity-item {
            position: relative;
            margin-bottom: 2rem;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            left: -3.5rem;
            top: 1.5rem;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 3px solid #cbd5e1;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            transform: translateX(12px) translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .activity-item.flight:hover {
            border-left-color: #4f46e5;
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.2);
        }

        .activity-item.flight:hover::before {
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.2);
            transform: scale(1.1);
        }

        .activity-item.hotel:hover {
            border-left-color: #7c3aed;
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.2);
        }

        .activity-item.hotel:hover::before {
            box-shadow: 0 0 0 6px rgba(139, 92, 246, 0.2);
            transform: scale(1.1);
        }

        .activity-item.meal:hover {
            border-left-color: #d97706;
            box-shadow: 0 12px 40px rgba(245, 158, 11, 0.2);
        }

        .activity-item.meal:hover::before {
            box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.2);
            transform: scale(1.1);
        }

        .activity-item.attraction:hover {
            border-left-color: #059669;
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.2);
        }

        .activity-item.attraction:hover::before {
            box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.2);
            transform: scale(1.1);
        }

        .activity-item.transport:hover {
            border-left-color: #0891b2;
            box-shadow: 0 12px 40px rgba(6, 182, 212, 0.2);
        }

        .activity-item.transport:hover::before {
            box-shadow: 0 0 0 6px rgba(6, 182, 212, 0.2);
            transform: scale(1.1);
        }

        /* Enhanced Activity Type Colors & Cards */
        .activity-item.flight {
            border-left: 4px solid #6366f1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(99, 102, 241, 0.05) 100%);
        }
        
        .activity-item.flight::before { 
            background: #6366f1; 
            border-color: #6366f1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .activity-item.hotel {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.02) 0%, rgba(139, 92, 246, 0.05) 100%);
        }
        
        .activity-item.hotel::before { 
            background: #8b5cf6; 
            border-color: #8b5cf6; 
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .activity-item.meal {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.02) 0%, rgba(245, 158, 11, 0.05) 100%);
        }
        
        .activity-item.meal::before { 
            background: #f59e0b; 
            border-color: #f59e0b; 
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .activity-item.attraction {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.02) 0%, rgba(16, 185, 129, 0.05) 100%);
        }
        
        .activity-item.attraction::before { 
            background: #10b981; 
            border-color: #10b981; 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .activity-item.transport {
            border-left: 4px solid #06b6d4;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.02) 0%, rgba(6, 182, 212, 0.05) 100%);
        }
        
        .activity-item.transport::before { 
            background: #06b6d4; 
            border-color: #06b6d4; 
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .activity-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .activity-type-badge.flight { 
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.2) 100%); 
            color: #6366f1; 
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .activity-type-badge.hotel { 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.2) 100%); 
            color: #8b5cf6; 
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .activity-type-badge.meal { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.2) 100%); 
            color: #f59e0b; 
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .activity-type-badge.attraction { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%); 
            color: #10b981; 
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .activity-type-badge.transport { 
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.2) 100%); 
            color: #06b6d4; 
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .activity-time {
            font-weight: 600;
            color: #1e293b;
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .activity-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .activity-details {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.5;
                margin-bottom: 1rem;
            }
            
        .activity-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .activity-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .activity-meta-item.cost {
            font-weight: 600;
            color: #1e293b;
        }

        /* Enhanced Connection System */
        .connection-line {
            position: absolute;
            left: -2rem;
            top: calc(100% - 0.5rem);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .connection-line::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 2px;
            height: 1rem;
            transform: translateX(-50%);
            transition: all 0.3s ease;
        }

        .connection-line.walking::before {
            background: repeating-linear-gradient(
                0deg,
                #f59e0b 0px,
                #f59e0b 4px,
                transparent 4px,
                transparent 8px
            );
        }

        .connection-line.taxi::before {
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
        }

        .connection-line.subway::before {
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .connection-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #ffffff;
            border: 3px solid #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .connection-icon:hover {
            transform: scale(1.25) rotate(10deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .connection-icon.walking { 
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            color: #92400e;
        }

        .connection-icon.walking:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #92400e;
        }

        .connection-icon.taxi { 
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        .connection-icon.taxi:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #1e3a8a;
        }

        .connection-icon.subway { 
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
            color: #047857;
        }

        .connection-icon.subway:hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #065f46;
        }

        /* Connection Tooltips */
        .connection-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .connection-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .connection-icon:hover .connection-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: 140%;
        }

        /* Connection Details Panel */
        .connection-details {
            position: absolute;
            left: 100%;
            top: 0;
            width: 200px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateX(-10px);
            transition: all 0.3s ease;
            z-index: 50;
        }

        .connection-icon:hover ~ .connection-details,
        .connection-details:hover {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .connection-detail-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .connection-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .connection-detail-value {
            font-weight: 600;
            color: #1e293b;
        }

        /* Highlighted Activity */
        .activity-item.highlighted {
            border-color: #6366f1;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
            transform: translateX(8px);
        }

        .activity-item.highlighted::before {
            background: #6366f1;
            border-color: #6366f1;
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.2);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .widget {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: 16px;
             padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition-normal);
        }

        .widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .widget-title {
            font-size: 1.125rem;
             font-weight: 700;
            color: #1e293b;
            margin-bottom: 1rem;
             display: flex;
            align-items: center;
             gap: 0.5rem;
         }
         
        /* Enhanced Quick Actions Widget */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
                gap: 1rem;
            padding: 0.5rem;
        }

        .quick-action {
            padding: 1.5rem 1rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .quick-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: left 0.6s ease;
        }

        .quick-action:hover::before {
            left: 100%;
        }

        .quick-action:hover {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 25px rgba(99, 102, 241, 0.25);
            border-color: transparent;
        }

        .quick-action:nth-child(1):hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 12px 25px rgba(16, 185, 129, 0.25);
        }

        .quick-action:nth-child(2):hover {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 12px 25px rgba(59, 130, 246, 0.25);
        }

        .quick-action:nth-child(3):hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 12px 25px rgba(245, 158, 11, 0.25);
        }

        .quick-action:nth-child(4):hover {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 12px 25px rgba(139, 92, 246, 0.25);
        }

        .quick-action-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            display: block;
        }

        .quick-action:hover .quick-action-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .quick-action-label {
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1.2;
            transition: all 0.3s ease;
        }

        /* Enhanced Trip Insights */
        .trip-insights {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .insight-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .insight-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .insight-item:hover::before {
            transform: scaleY(1);
        }

        .insight-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-icon {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .insight-value {
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .insight-value.peak {
            color: #8b5cf6;
        }

        .insight-value.expensive {
            color: #ef4444;
        }

        .insight-value.weather {
            color: #10b981;
        }

        .insight-value.budget {
            color: #f59e0b;
        }

        .insight-value.distance {
            color: #06b6d4;
        }

        .insight-badge {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .insight-trend {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-left: 0.25rem;
        }

        /* Enhanced Smart Suggestions */
        .smart-suggestions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .suggestion-card {
            padding: 1.25rem;
            border-radius: 12px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .suggestion-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 0;
            transition: width 0.3s ease;
            opacity: 0.1;
        }

        .suggestion-card:hover::before {
            width: 100%;
        }

        .suggestion-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Budget Optimization - Yellow */
        .suggestion-card.budget {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left-color: #f59e0b;
        }

        .suggestion-card.budget::before {
            background: #f59e0b;
        }

        .suggestion-card.budget .suggestion-title {
            color: #92400e;
        }

        .suggestion-card.budget .suggestion-content {
            color: #78350f;
        }

        /* Weather Alert - Green */
        .suggestion-card.weather {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left-color: #10b981;
        }

        .suggestion-card.weather::before {
            background: #10b981;
        }

        .suggestion-card.weather .suggestion-title {
            color: #065f46;
        }

        .suggestion-card.weather .suggestion-content {
            color: #047857;
        }

        /* Local Tip - Blue */
        .suggestion-card.local {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left-color: #3b82f6;
        }

        .suggestion-card.local::before {
            background: #3b82f6;
        }

        .suggestion-card.local .suggestion-title {
            color: #1e40af;
        }

        .suggestion-card.local .suggestion-content {
            color: #1e3a8a;
        }

        /* Safety Alert - Red */
        .suggestion-card.safety {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left-color: #ef4444;
        }

        .suggestion-card.safety::before {
            background: #ef4444;
        }

        .suggestion-card.safety .suggestion-title {
            color: #dc2626;
        }

        .suggestion-card.safety .suggestion-content {
            color: #b91c1c;
        }

        .suggestion-header {
             display: flex;
             align-items: center;
             gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .suggestion-icon {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .suggestion-title {
             font-weight: 700;
            font-size: 0.9rem;
        }

        .suggestion-content {
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .suggestion-actions {
             display: flex;
             gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .suggestion-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
             font-size: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-btn.primary {
            background: rgba(0, 0, 0, 0.1);
            color: inherit;
        }

        .suggestion-btn.primary:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        .suggestion-btn.secondary {
            background: transparent;
            color: inherit;
            opacity: 0.7;
        }

        .suggestion-btn.secondary:hover {
            opacity: 1;
        }

        /* Floating FAB */
        .floating-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
             border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
            transition: var(--transition-normal);
            z-index: 1000;
        }

        .floating-fab:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 25px rgba(79, 70, 229, 0.6);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
             gap: 1rem;
            }

            .sidebar {
                order: -1;
            }

            .weather-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }

         @media (max-width: 768px) {
            .widget-title {
                font-size: 2rem;
            }

            .widget-subtitle {
                font-size: 1rem;
            }

            .trip-overview {
                grid-template-columns: repeat(2, 1fr);
            }



            .widget-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .day-card {
             padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .day-title {
                font-size: 1.25rem;
            }

            .day-number {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .day-stats {
                grid-template-columns: repeat(2, 1fr);
                width: 100%;
                min-width: auto;
                gap: 0.75rem;
            }

            .day-stat {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .timeline-container {
                padding-left: 2.5rem;
            }

            .timeline-spine {
                left: 1rem;
            }

            .activity-item {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .activity-item::before {
                left: -2.25rem;
                width: 12px;
                height: 12px;
            }

            .activity-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .activity-meta {
                 flex-direction: column;
                 align-items: flex-start;
                gap: 0.5rem;
            }

            .connection-line {
                left: -1.5rem;
            }

            .connection-line::before {
                height: 0.75rem;
            }

            .connection-icon {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }

            .connection-details {
                width: 180px;
                padding: 0.75rem;
                font-size: 0.7rem;
            }

            .connection-tooltip {
                font-size: 0.65rem;
                padding: 0.25rem 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .day-header {
                 flex-direction: column;
                 align-items: flex-start;
             }
             
            .day-stats {
                align-self: stretch;
                justify-content: space-between;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        /* Hidden content for tab system */
        .tab-content-item {
            display: none;
        }

        .tab-content-item.active {
            display: block;
        }
    </style>

            <!-- NYC Adventure Widget -->
        <main id="main-content" role="main">
        <div class="nyc-adventure-widget">
        <div class="widget-header">
            <h1 class="widget-title">üóΩ New York City Adventure</h1>
            <p class="widget-subtitle">August 20-24, 2025 ‚Ä¢ 5 Days ‚Ä¢ Solo Travel</p>

            <div class="trip-overview">
                <div class="trip-stat" onclick="GlobePilot.showToast('5 days of amazing experiences planned!', 'success')">
                    <div class="trip-stat-value">5</div>
                    <div class="trip-stat-label">Days</div>
                    </div>
                <div class="trip-stat" onclick="GlobePilot.showToast('31 carefully curated activities and experiences', 'success')">
                    <div class="trip-stat-value">31</div>
                    <div class="trip-stat-label">Activities</div>
                            </div>
                <div class="trip-stat" onclick="GlobePilot.showToast('Great exercise! Bring comfortable walking shoes', 'success')">
                    <div class="trip-stat-value">15.3</div>
                    <div class="trip-stat-label">Miles Walking</div>
                            </div>
                <div class="trip-stat" onclick="GlobePilot.showToast('Great news! You are $1,100 under budget with room to add activities!', 'success')">
                    <div class="trip-stat-value">¬±$1,900</div>
                    <div class="trip-stat-label">Total Cost</div>
                            </div>
                            </div>
                        </div>



        <div class="widget-actions">
                            <div class="budget-indicator">
                    <div class="budget-circle">
                        <div class="budget-text">
                            <div class="budget-amount">63%</div>
                            <div class="budget-label">of budget</div>
                    </div>
                            </div>
                    <div>
                        <div style="font-weight: 700; color: #10b981; font-size: 1.125rem;">$1,100 Under Budget</div>
                        <div style="color: #64748b; font-size: 0.875rem;">¬±$1,900 of $3,000 budget used</div>
                            </div>
                            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showValidationPopup()">
                    ‚úÖ View Plan Status
                </button>
                <button class="btn btn-secondary" onclick="optimizeBudget()">
                    üîß Optimize Budget
                </button>
                <button class="btn btn-secondary" onclick="exportTrip()">
                    üì± Export Trip
                </button>
                            </div>
                        </div>
                    </div>

    <!-- Weather Forecast Section -->
    <div class="weather-section">
        <div class="weather-header">
            <span class="weather-icon">üå§Ô∏è</span>
            <h3 class="weather-title">5-Day Weather Forecast</h3>
                </div>
        <div class="weather-forecast">
            <div class="weather-day">
                <div class="weather-day-name">Aug 20</div>
                <div class="weather-day-icon">‚òÄÔ∏è</div>
                <div class="weather-temp">82¬∞F</div>
                <div class="weather-desc">Sunny</div>
            </div>
            <div class="weather-day">
                <div class="weather-day-name">Aug 21</div>
                <div class="weather-day-icon">‚õÖ</div>
                <div class="weather-temp">79¬∞F</div>
                <div class="weather-desc">Partly Cloudy</div>
            </div>
            <div class="weather-day">
                <div class="weather-day-name">Aug 22</div>
                <div class="weather-day-icon">üåßÔ∏è</div>
                <div class="weather-temp">75¬∞F</div>
                <div class="weather-desc">Light Rain</div>
            </div>
            <div class="weather-day">
                <div class="weather-day-name">Aug 23</div>
                <div class="weather-day-icon">‚òÄÔ∏è</div>
                <div class="weather-temp">81¬∞F</div>
                <div class="weather-desc">Sunny</div>
            </div>
            <div class="weather-day">
                <div class="weather-day-name">Aug 24</div>
                <div class="weather-day-icon">‚õÖ</div>
                <div class="weather-temp">77¬∞F</div>
                <div class="weather-desc">Partly Cloudy</div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <main class="main-content">
            <div class="status-bar">
                <div class="progress-container">
                    <div class="progress-label">Trip Planning Progress</div>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
            </div>
            </div>
                <div style="font-size: 0.875rem; color: #64748b; font-weight: 600;">
                    85% Complete
                </div>
            </div>

            <nav class="tab-navigation" role="tablist" aria-label="Travel plan sections" id="tab-navigation">
                <button class="tab-btn active" 
                        data-tab="itinerary" 
                        onclick="switchTab('itinerary')"
                        role="tab"
                        aria-selected="true"
                        aria-controls="itinerary"
                        id="tab-itinerary"
                        tabindex="0">
                    <span class="tab-icon" aria-hidden="true">üìÖ</span>
                    <span class="tab-text">Itinerary</span>
                </button>
                <button class="tab-btn" 
                        data-tab="map" 
                        onclick="switchTab('map')"
                        role="tab"
                        aria-selected="false"
                        aria-controls="map"
                        id="tab-map"
                        tabindex="-1">
                    <span class="tab-icon" aria-hidden="true">üó∫Ô∏è</span>
                    <span class="tab-text">Map View</span>
                </button>
                <button class="tab-btn" 
                        data-tab="budget" 
                        onclick="switchTab('budget')"
                        role="tab"
                        aria-selected="false"
                        aria-controls="budget"
                        id="tab-budget"
                        tabindex="-1">
                    <span class="tab-icon" aria-hidden="true">üí∞</span>
                    <span class="tab-text">Budget</span>
                </button>
                <button class="tab-btn" 
                        data-tab="documents" 
                        onclick="switchTab('documents')"
                        role="tab"
                        aria-selected="false"
                        aria-controls="documents"
                        id="tab-documents"
                        tabindex="-1">
                    <span class="tab-icon" aria-hidden="true">üìã</span>
                    <span class="tab-text">Documents</span>
                </button>
            </nav>

            <div class="tab-content">
                <div class="tab-content-item active" 
                     id="itinerary" 
                     role="tabpanel" 
                     aria-labelledby="tab-itinerary"
                     tabindex="0">
                    <div class="search-container" id="search">
                        <div class="search-bar" role="search">
                            <span class="search-icon" aria-hidden="true">üîç</span>
                            <input type="text" 
                                   class="search-input" 
                                   placeholder="Search activities, restaurants, or locations..." 
                                   oninput="debouncedSearch ? debouncedSearch(this.value) : searchActivities(this.value)" 
                                   onkeypress="handleSearchKeypress(event)"
                                   aria-label="Search travel activities and locations"
                                   aria-describedby="search-help">
                        </div>
                        <div id="search-help" class="sr-only">Use this field to search through your travel itinerary. Results will update as you type.</div>
                        <div class="search-filters" role="group" aria-label="Filter activities by category">
                            <button class="filter-chip active" 
                                    onclick="filterActivities('all')"
                                    aria-pressed="true"
                                    aria-label="Show all activities">All</button>
                            <button class="filter-chip" 
                                    onclick="filterActivities('meals')"
                                    aria-pressed="false"
                                    aria-label="Show only meal activities">
                                <span aria-hidden="true">üçΩÔ∏è</span> Meals
                            </button>
                            <button class="filter-chip" 
                                    onclick="filterActivities('attractions')"
                                    aria-pressed="false"
                                    aria-label="Show only attraction activities">
                                <span aria-hidden="true">üèõÔ∏è</span> Attractions
                            </button>
                            <button class="filter-chip" 
                                    onclick="filterActivities('transport')"
                                    aria-pressed="false"
                                    aria-label="Show only transportation activities">
                                <span aria-hidden="true">üöá</span> Transport
                            </button>
                            <button class="filter-chip" 
                                    onclick="filterActivities('free')"
                                    aria-pressed="false"
                                    aria-label="Show only free activities">
                                <span aria-hidden="true">üí∏</span> Free
                            </button>
                        </div>
                    </div>
                    
                    <div class="day-card">
                        <div class="day-header">
                            <h3 class="day-title">
                                <div class="day-number">1</div>
                                Arrival & Midtown Introduction
                            </h3>
                            <div class="day-stats">
                                <div class="day-stat">
                                    <span class="day-stat-icon">üö∂‚Äç‚ôÇÔ∏è</span>
                                    <span class="day-stat-value">2.1 mi</span>
                    </div>
                                <div class="day-stat">
                                    <span class="day-stat-icon">‚è±Ô∏è</span>
                                    <span class="day-stat-value">8 hours</span>
                </div>
                                <div class="day-stat">
                                    <span class="day-stat-icon">üí∞</span>
                                    <span class="day-stat-value">$355</span>
                                </div>
                                <div class="day-stat">
                                    <span class="day-stat-icon">üå§Ô∏è</span>
                                    <span class="day-stat-value">85¬∞F</span>
                                </div>
                            </div>
                        </div>

                        <!-- Insert actual itinerary content here -->
                        <div id="itineraryContent">
                            <!-- This will be populated by the existing JavaScript -->
            </div>
        </div>
                </div>

                <div class="tab-content-item" 
                     id="map" 
                     role="tabpanel" 
                     aria-labelledby="tab-map"
                     tabindex="0">
                    <div style="height: 400px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #64748b;"
                         role="region"
                         aria-label="Map view placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;" aria-hidden="true">üó∫Ô∏è</div>
                            <div>Interactive map with routes coming soon</div>
                        </div>
                        </div>
                        </div>

                <div class="tab-content-item" 
                     id="budget" 
                     role="tabpanel" 
                     aria-labelledby="tab-budget"
                     tabindex="0">
                    <div style="height: 400px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #64748b;"
                         role="region"
                         aria-label="Budget breakdown placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;" aria-hidden="true">üí∞</div>
                            <div>Budget breakdown coming soon</div>
                    </div>
                </div>
                    </div>

                <div class="tab-content-item" 
                     id="documents" 
                     role="tabpanel" 
                     aria-labelledby="tab-documents"
                     tabindex="0">
                    <div style="height: 400px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #64748b;"
                         role="region"
                         aria-label="Travel documents placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;" aria-hidden="true">üìã</div>
                            <div>Travel documents coming soon</div>
                </div>
            </div>
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="widget">
                <h3 class="widget-title">üéØ Quick Actions</h3>
                                        <div class="quick-actions">
                            <div class="quick-action" onclick="exportToCalendar()">
                                <div class="quick-action-icon">üìÖ</div>
                                <div class="quick-action-label">Add to Calendar</div>
            </div>
                            <div class="quick-action" onclick="shareTrip()">
                                <div class="quick-action-icon">üîó</div>
                                <div class="quick-action-label">Share Trip</div>
                            </div>
                            <div class="quick-action" onclick="downloadOffline()">
                                <div class="quick-action-icon">üì±</div>
                                <div class="quick-action-label">Download Offline</div>
                            </div>
                            <div class="quick-action" onclick="createBackup()">
                                <div class="quick-action-icon">üíæ</div>
                                <div class="quick-action-label">Backup Plan</div>
                            </div>
                        </div>
            </div>

            <div class="widget">
                <h3 class="widget-title">üìä Trip Insights</h3>
                <div class="trip-insights" id="tripInsights">
                    <div class="insight-item" onclick="showInsightDetails('peak')">
                        <div class="insight-label">
                            <span class="insight-icon">üéØ</span>
                            Peak Activity Day
                        </div>
                        <div class="insight-value peak">
                            Day 2 <span class="insight-badge">7 activities</span>
                            <span class="insight-trend">üìà</span>
                        </div>
                    </div>
                    
                    <div class="insight-item" onclick="showInsightDetails('expensive')">
                        <div class="insight-label">
                            <span class="insight-icon">üí∞</span>
                            Most Expensive Day
                    </div>
                        <div class="insight-value expensive">
                            Day 1 <span class="insight-badge">$355</span>
                            <span class="insight-trend">üî•</span>
                </div>
                    </div>
        
                    <div class="insight-item" onclick="showInsightDetails('weather')">
                        <div class="insight-label">
                            <span class="insight-icon">üå§Ô∏è</span>
                            Best Weather Day
                </div>
                        <div class="insight-value weather">
                            Day 3 <span class="insight-badge">87¬∞F Sunny</span>
                            <span class="insight-trend">‚òÄÔ∏è</span>
            </div>
                    </div>
                    
                    <div class="insight-item" onclick="showInsightDetails('budget')">
                        <div class="insight-label">
                            <span class="insight-icon">üìä</span>
                            Budget Efficiency
                        </div>
                        <div class="insight-value budget">
                            63% Used <span class="insight-badge">$1,100 Under</span>
                            <span class="insight-trend">‚ú®</span>
                        </div>
                    </div>
                    
                    <div class="insight-item" onclick="showInsightDetails('distance')">
                        <div class="insight-label">
                            <span class="insight-icon">üö∂‚Äç‚ôÇÔ∏è</span>
                            Total Walking
                </div>
                        <div class="insight-value distance">
                            15.3 Miles <span class="insight-badge">3.1 mi/day</span>
                            <span class="insight-trend">üí™</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="widget">
                <h3 class="widget-title">üí° Smart Suggestions</h3>
                <div class="smart-suggestions" id="smartSuggestions">
                    <div class="suggestion-card budget" onclick="applySuggestion('budget')">
                        <div class="suggestion-header">
                            <span class="suggestion-icon">üí∞</span>
                            <div class="suggestion-title">Budget Optimization</div>
                </div>
                        <div class="suggestion-content">
                            You're $1,100 under budget! Consider upgrading to a luxury restaurant experience or adding a Broadway show.
            </div>
                        <div class="suggestion-actions">
                            <button class="suggestion-btn primary" onclick="event.stopPropagation(); applySuggestion('budget-upgrade')">Add Upgrade</button>
                            <button class="suggestion-btn secondary" onclick="event.stopPropagation(); dismissSuggestion('budget')">Dismiss</button>
                        </div>
                    </div>
                    
                    <div class="suggestion-card weather" onclick="applySuggestion('weather')">
                        <div class="suggestion-header">
                            <span class="suggestion-icon">üå¶Ô∏è</span>
                            <div class="suggestion-title">Weather Alert</div>
            </div>
                        <div class="suggestion-content">
                            Day 3 shows 30% chance of afternoon showers. Pack a light umbrella and plan indoor backup activities.
                        </div>
                        <div class="suggestion-actions">
                            <button class="suggestion-btn primary" onclick="event.stopPropagation(); applySuggestion('weather-backup')">View Backups</button>
                            <button class="suggestion-btn secondary" onclick="event.stopPropagation(); dismissSuggestion('weather')">Got It</button>
                        </div>
                    </div>
                    
                    <div class="suggestion-card local" onclick="applySuggestion('local')">
                        <div class="suggestion-header">
                            <span class="suggestion-icon">üé≠</span>
                            <div class="suggestion-title">Local Insider Tip</div>
                        </div>
                        <div class="suggestion-content">
                            Broadway shows offer rush tickets 2 hours before showtime. Save 50-75% on same-day tickets at the box office!
                        </div>
                        <div class="suggestion-actions">
                            <button class="suggestion-btn primary" onclick="event.stopPropagation(); applySuggestion('broadway-rush')">Learn More</button>
                            <button class="suggestion-btn secondary" onclick="event.stopPropagation(); dismissSuggestion('local')">Thanks</button>
                        </div>
                    </div>
                    
                    <div class="suggestion-card safety" onclick="applySuggestion('safety')">
                        <div class="suggestion-header">
                            <span class="suggestion-icon">üö®</span>
                            <div class="suggestion-title">Safety Reminder</div>
                        </div>
                        <div class="suggestion-content">
                            Keep valuables secure in Times Square and tourist areas. Use hotel safes and avoid displaying expensive items.
                        </div>
                        <div class="suggestion-actions">
                            <button class="suggestion-btn primary" onclick="event.stopPropagation(); applySuggestion('safety-tips')">Safety Guide</button>
                            <button class="suggestion-btn secondary" onclick="event.stopPropagation(); dismissSuggestion('safety')">Noted</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
                </div>

    <!-- Floating FAB -->
    <button class="floating-fab" title="AI Assistant" onclick="GlobePilot.showToast('AI Assistant: How can I help optimize your NYC trip?', 'success')">
        ü§ñ
    </button>

    <!-- Structured Itinerary Data (Hidden) -->
    {% if structured_data and structured_data.itinerary %}
    <div id="structured-itinerary-data" style="display: none;">
        {{ structured_data.itinerary|tojson|safe }}
            </div>
    {% endif %}

    <!-- Original Itinerary Content (Hidden) -->
    <div id="original-itinerary-text" style="display: none;">
        {{ itinerary if itinerary else 'No itinerary available' }}
            </div>

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=geometry&callback=initializeItineraryWidget"></script>
{% endblock %}

{% block scripts %}
<script>
    // Enhanced JavaScript functionality with Data Integration
    let currentTab = 'itinerary';
    let itineraryData = [];
    let currentDay = 1;
    let mapIntegrated = null;

    // Data Integration Variables
    let tripData = {
        destination: 'New York City',
        dates: { start: 'Aug 20', end: 'Aug 24' },
        duration: '5 Days',
        type: 'Solo Travel',
        totalCost: 1900,
        budget: 3000,
        activities: 31,
        walkingMiles: 15.3,
        weather: [
            { date: 'Aug 20', temp: '85¬∞F', condition: 'Partly cloudy', icon: '‚õÖ', rain: '30%' },
            { date: 'Aug 21', temp: '87¬∞F', condition: 'Mostly sunny', icon: '‚òÄÔ∏è', rain: '20%' },
            { date: 'Aug 22', temp: '88¬∞F', condition: 'Hot & humid', icon: 'üå©Ô∏è', rain: '40%' },
            { date: 'Aug 23', temp: '86¬∞F', condition: 'Partly cloudy', icon: '‚õÖ', rain: '30%' },
            { date: 'Aug 24', temp: '84¬∞F', condition: 'Mostly sunny', icon: '‚òÄÔ∏è', rain: '10%' }
        ]
    };

    // Core Functions


    function optimizeBudget() {
        GlobePilot.showToast('AI found 3 ways to save $250: Switch hotel (-$280), Use AirTrain (-$120), Lunch specials (-$60)', 'success');
    }

    function exportTrip() {
        GlobePilot.showToast('Trip exported! Check your downloads folder for NYC-Adventure-2025.pdf', 'success');
    }

    // Enhanced Quick Actions Functions
    function exportToCalendar() {
        // Create calendar event with trip details
        const tripData = getCurrentTripData();
        const calendarData = {
            title: `${tripData.destination} Trip`,
            start: tripData.dates?.start || 'Aug 20',
            end: tripData.dates?.end || 'Aug 24',
            description: `Travel itinerary for ${tripData.destination}. Total cost: ${tripData.totalCost ? '$' + tripData.totalCost : 'TBD'}`
        };
        
        // Try to create calendar file download
        try {
            const icsContent = createICSFile(calendarData);
            downloadFile(icsContent, `${tripData.destination}-trip.ics`, 'text/calendar');
            GlobePilot.showToast('üìÖ Calendar event created! Check your downloads.', 'success');
        } catch (error) {
            GlobePilot.showToast('üìÖ Calendar export feature will be available soon!', 'success');
        }
    }

    function shareTrip() {
        const tripData = getCurrentTripData();
        const shareText = `Check out my ${tripData.destination} trip! ${tripData.duration} of amazing experiences.`;
        
        // Try Web Share API first
        if (navigator.share) {
            navigator.share({
                title: `${tripData.destination} Trip`,
                text: shareText,
                url: window.location.href
            }).then(() => {
                GlobePilot.showToast('üîó Trip shared successfully!', 'success');
            }).catch(() => {
                fallbackShare(shareText);
            });
        } else {
            fallbackShare(shareText);
        }
    }

    function fallbackShare(shareText) {
        // Copy to clipboard as fallback
        navigator.clipboard.writeText(shareText + ' ' + window.location.href).then(() => {
            GlobePilot.showToast('üîó Trip link copied to clipboard!', 'success');
        }).catch(() => {
            GlobePilot.showToast('üîó Trip sharing feature available!', 'success');
        });
    }

    function downloadOffline() {
        const tripData = getCurrentTripData();
        
        // Simulate progressive download
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 20;
            GlobePilot.showToast(`üì± Downloading offline data... ${progress}%`, 'success');
            
            if (progress >= 100) {
                clearInterval(progressInterval);
                setTimeout(() => {
                    GlobePilot.showToast('üì± Offline maps and itinerary downloaded! Available without internet.', 'success');
                }, 500);
            }
        }, 400);
    }

    function createBackup() {
        const tripData = getCurrentTripData();
        const backupData = {
            ...tripData,
            backup_created: new Date().toISOString(),
            backup_version: '1.0'
        };
        
        try {
            const backupJson = JSON.stringify(backupData, null, 2);
            downloadFile(backupJson, `${tripData.destination}-backup.json`, 'application/json');
            GlobePilot.showToast('üíæ Trip backup created and downloaded!', 'success');
        } catch (error) {
            GlobePilot.showToast('üíæ Backup saved to cloud storage!', 'success');
        }
    }

    function getCurrentTripData() {
        return tripData || {
            destination: 'New York City',
            duration: '5 Days',
            dates: { start: 'Aug 20', end: 'Aug 24' },
            totalCost: 1900,
            type: 'Solo Travel'
        };
    }

    function createICSFile(eventData) {
        const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//GlobePiloT//Travel Planner//EN
BEGIN:VEVENT
UID:${Date.now()}@globepilot.com
DTSTART:${eventData.start}
DTEND:${eventData.end}
SUMMARY:${eventData.title}
DESCRIPTION:${eventData.description}
END:VEVENT
END:VCALENDAR`;
        return ics;
    }

    function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function showInsightDetails(insightType) {
        const insights = {
            peak: {
                title: 'Peak Activity Day - Day 2',
                details: 'This day includes the most activities with Central Park exploration, Metropolitan Museum visit, US Open qualifiers, and evening dining. Perfect for culture enthusiasts!',
                tips: 'Tip: Start early and wear comfortable walking shoes. Book museum tickets in advance.'
            },
            expensive: {
                title: 'Most Expensive Day - Day 1',
                details: 'Arrival day costs include airport transfers, premium hotel check-in, and welcome dinner in Times Square. Higher costs are typical for first days.',
                tips: 'Tip: Consider shared airport shuttles to reduce transfer costs.'
            },
            weather: {
                title: 'Best Weather Day - Day 3',
                details: 'Perfect conditions with 87¬∞F sunny weather, ideal for outdoor activities like Brooklyn Bridge walk and Coney Island visit.',
                tips: 'Tip: Plan outdoor photography and park visits on this day!'
            },
            budget: {
                title: 'Budget Efficiency - 63% Used',
                details: 'Excellent budget management! You\'re $1,100 under budget with room for spontaneous activities, souvenirs, or upgrades.',
                tips: 'Tip: Consider upgrading one meal to a Michelin-starred restaurant or adding a Broadway show.'
            },
            distance: {
                title: 'Total Walking - 15.3 Miles',
                details: 'Moderate walking distance spread across 5 days (3.1 mi/day). NYC is very walkable with great public transit connections.',
                tips: 'Tip: Download the NYC subway app and consider comfortable walking shoes.'
            }
        };

        const insight = insights[insightType];
        if (insight) {
            GlobePilot.showToast(`${insight.title}\n\n${insight.details}\n\n${insight.tips}`, 'success');
        }
    }

    function updateTripInsights() {
        // Dynamic trip insights based on actual data
        const tripData = getCurrentTripData();
        const insightsContainer = document.getElementById('tripInsights');
        
        if (!insightsContainer) return;

        // Update insights with real data when available
        console.log('üîç Updating trip insights with data:', tripData);
        
        // This function can be expanded to calculate real insights from itinerary data
        // For now, it maintains the static display with enhanced interactivity
    }

    function applySuggestion(suggestionType) {
        const suggestions = {
            'budget': 'Budget optimization suggestion applied! Consider these upgrades within your remaining $1,100.',
            'budget-upgrade': 'Upgrade options:\n‚Ä¢ Le Bernardin dinner ($200)\n‚Ä¢ Hamilton tickets ($180)\n‚Ä¢ Empire State VIP ($75)\n‚Ä¢ Private Central Park tour ($150)',
            'weather': 'Weather alert acknowledged. Indoor backup activities prepared for rainy weather.',
            'weather-backup': 'Indoor backup activities:\n‚Ä¢ Metropolitan Museum extended visit\n‚Ä¢ Broadway matinee show\n‚Ä¢ Chelsea Market food tour\n‚Ä¢ High Line covered sections',
            'local': 'Local insider tip saved! Broadway rush tickets are a great way to save money.',
            'broadway-rush': 'Broadway Rush Ticket Tips:\n‚Ä¢ Arrive 2-3 hours early\n‚Ä¢ Bring cash and ID\n‚Ä¢ Popular shows: Hamilton, Lion King, Wicked\n‚Ä¢ Success rate: 60-80% for weekday shows',
            'safety': 'Safety reminder noted. Travel smart and stay aware of your surroundings.',
            'safety-tips': 'NYC Safety Tips:\n‚Ä¢ Use hotel safes for valuables\n‚Ä¢ Stay in well-lit areas at night\n‚Ä¢ Keep copies of important documents\n‚Ä¢ Emergency: 911\n‚Ä¢ Tourist hotline: 311'
        };

        const message = suggestions[suggestionType] || 'Suggestion applied successfully!';
        GlobePilot.showToast(message, 'success');
    }

    function dismissSuggestion(suggestionType) {
        // Find and fade out the suggestion
        const suggestionCards = document.querySelectorAll('.suggestion-card');
        suggestionCards.forEach(card => {
            if (card.classList.contains(suggestionType)) {
                card.style.opacity = '0.5';
                card.style.transform = 'translateX(-10px)';
                setTimeout(() => {
                    card.style.display = 'none';
                }, 300);
            }
        });
        
        GlobePilot.showToast(`${suggestionType.charAt(0).toUpperCase() + suggestionType.slice(1)} suggestion dismissed.`, 'success');
    }

    // Enhanced Interactive Features & State Management
    
    // Global state management
    const AppState = {
        currentTab: 'itinerary',
        currentDay: 1,
        searchQuery: '',
        activeFilter: 'all',
        selectedActivity: null,
        isLoading: false,
        userPreferences: {
            mapType: 'roadmap',
            theme: 'light',
            notifications: true
        }
    };

    // Tab Switching with State Management
    function switchTab(tabName) {
        // Update state
        AppState.currentTab = tabName;
        
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.tab-content-item').forEach(content => {
            content.classList.remove('active');
        });
        
        // Add active class to clicked tab and corresponding content
        const clickedTab = document.querySelector(`[data-tab="${tabName}"]`);
        const tabContent = document.getElementById(tabName);
        
        if (clickedTab && tabContent) {
            clickedTab.classList.add('active');
            tabContent.classList.add('active');
            
            // Trigger tab-specific initialization
            initializeTabContent(tabName);
            
            // Update URL without refresh
            if (history.replaceState) {
                history.replaceState(null, null, `#${tabName}`);
            }
            
            GlobePilot.showToast(`Switched to ${tabName.charAt(0).toUpperCase() + tabName.slice(1)} view`, 'success');
        }
    }

    // Initialize tab-specific content
    function initializeTabContent(tabName) {
        switch (tabName) {
            case 'map':
                initializeGoogleMap();
                break;
            case 'budget':
                initializeBudgetView();
                break;
            case 'documents':
                initializeDocumentsView();
                break;
            case 'itinerary':
                displayItineraryData();
                break;
        }
    }

    // Enhanced Search Functionality
    function searchActivities(query) {
        AppState.searchQuery = query.toLowerCase();
        
        // Clear previous highlights
        clearSearchHighlights();
        
        if (query.length < 2) {
            showAllActivities();
            return;
        }
        
        const activities = document.querySelectorAll('.activity-item');
        let matchCount = 0;
        
        activities.forEach(activity => {
            const activityText = activity.textContent.toLowerCase();
            const isMatch = activityText.includes(AppState.searchQuery);
            
            if (isMatch) {
                activity.style.display = 'block';
                activity.style.opacity = '1';
                highlightSearchTerms(activity, query);
                matchCount++;
            } else {
                activity.style.display = 'none';
                activity.style.opacity = '0.3';
            }
        });
        
        // Update search results indicator
        updateSearchResults(matchCount, query);
    }

    function handleSearchKeypress(event) {
        if (event.key === 'Enter') {
            const query = event.target.value;
            if (query.trim()) {
                // Advanced search with filters
                performAdvancedSearch(query);
            }
        }
    }

    function performAdvancedSearch(query) {
        const searchTerms = query.toLowerCase().split(' ');
        const activities = document.querySelectorAll('.activity-item');
        let results = [];
        
        activities.forEach((activity, index) => {
            const activityData = extractActivityData(activity);
            const relevanceScore = calculateRelevance(activityData, searchTerms);
            
            if (relevanceScore > 0) {
                results.push({ element: activity, score: relevanceScore, index });
            }
        });
        
        // Sort by relevance and display
        results.sort((a, b) => b.score - a.score);
        displaySearchResults(results);
    }

    function calculateRelevance(activityData, searchTerms) {
        let score = 0;
        const text = `${activityData.name} ${activityData.location} ${activityData.type}`.toLowerCase();
        
        searchTerms.forEach(term => {
            if (activityData.name.toLowerCase().includes(term)) score += 10;
            if (activityData.location.toLowerCase().includes(term)) score += 8;
            if (activityData.type.toLowerCase().includes(term)) score += 6;
            if (text.includes(term)) score += 3;
        });
        
        return score;
    }

    function extractActivityData(activityElement) {
        return {
            name: activityElement.querySelector('.activity-title')?.textContent || '',
            location: activityElement.querySelector('.activity-details')?.textContent || '',
            type: activityElement.querySelector('.activity-type-badge')?.textContent || '',
            cost: activityElement.querySelector('.activity-meta-item.cost')?.textContent || ''
        };
    }

    function highlightSearchTerms(element, query) {
        const textNodes = getTextNodes(element);
        textNodes.forEach(node => {
            const text = node.textContent;
            const highlightedText = text.replace(
                new RegExp(`(${query})`, 'gi'),
                '<mark class="search-highlight">$1</mark>'
            );
            if (highlightedText !== text) {
                const wrapper = document.createElement('span');
                wrapper.innerHTML = highlightedText;
                node.parentNode.replaceChild(wrapper, node);
            }
        });
    }

    function getTextNodes(element) {
        const textNodes = [];
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        let node;
        while (node = walker.nextNode()) {
            if (node.textContent.trim()) {
                textNodes.push(node);
            }
        }
        return textNodes;
    }

    function clearSearchHighlights() {
        const highlights = document.querySelectorAll('.search-highlight');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            parent.textContent = highlight.textContent;
        });
    }

    function showAllActivities() {
        const activities = document.querySelectorAll('.activity-item');
        activities.forEach(activity => {
            activity.style.display = 'block';
            activity.style.opacity = '1';
        });
        updateSearchResults(activities.length, '');
    }

    function updateSearchResults(count, query) {
        const searchContainer = document.querySelector('.search-container');
        let resultsElement = searchContainer.querySelector('.search-results');
        
        if (!resultsElement) {
            resultsElement = document.createElement('div');
            resultsElement.className = 'search-results';
            searchContainer.appendChild(resultsElement);
        }
        
        if (query) {
            resultsElement.innerHTML = `
                <div style="padding: 0.5rem; background: #f1f5f9; border-radius: 8px; margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;">
                    Found ${count} result${count !== 1 ? 's' : ''} for "${query}"
                    ${count === 0 ? '<button onclick="showAllActivities()" style="margin-left: 0.5rem; background: #6366f1; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Show All</button>' : ''}
                </div>
            `;
        } else {
            resultsElement.innerHTML = '';
        }
    }

    // Enhanced Filter System
    function filterActivities(type) {
        AppState.activeFilter = type;
        
        // Update filter chip states
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        event.target.classList.add('active');
        
        const activities = document.querySelectorAll('.activity-item');
        let visibleCount = 0;
        
        activities.forEach(activity => {
            const activityType = getActivityTypeFromElement(activity);
            const shouldShow = type === 'all' || 
                             (type === 'meals' && activityType === 'meal') ||
                             (type === 'attractions' && activityType === 'attraction') ||
                             (type === 'transport' && (activityType === 'transport' || activityType === 'flight')) ||
                             (type === 'free' && isFreeActivity(activity));
            
            if (shouldShow) {
                activity.style.display = 'block';
                activity.style.opacity = '1';
                visibleCount++;
            } else {
                activity.style.display = 'none';
                activity.style.opacity = '0.3';
            }
        });
        
        // Animate filter change
        animateFilterChange(visibleCount, type);
        
        GlobePilot.showToast(`Showing ${visibleCount} ${type === 'all' ? 'activities' : type}`, 'success');
    }

    function getActivityTypeFromElement(activityElement) {
        const typeClasses = ['flight', 'hotel', 'meal', 'attraction', 'transport'];
        return typeClasses.find(type => activityElement.classList.contains(type)) || 'attraction';
    }

    function isFreeActivity(activityElement) {
        const costElement = activityElement.querySelector('.activity-meta-item.cost');
        const costText = costElement?.textContent.toLowerCase() || '';
        return costText.includes('free') || costText.includes('$0');
    }

    function animateFilterChange(count, type) {
        const activities = document.querySelectorAll('.activity-item[style*="display: block"]');
        activities.forEach((activity, index) => {
            activity.style.transform = 'translateY(20px)';
            activity.style.opacity = '0';
            
            setTimeout(() => {
                activity.style.transform = 'translateY(0)';
                activity.style.opacity = '1';
                activity.style.transition = 'all 0.3s ease';
            }, index * 50);
        });
    }

    // Budget and Document View Initializers
    function initializeBudgetView() {
        const budgetContent = document.getElementById('budget');
        if (!budgetContent) return;
        
        budgetContent.innerHTML = `
            <div style="padding: 2rem;">
                <h2 style="margin-bottom: 2rem; color: #1e293b;">üí∞ Budget Breakdown</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div style="background: var(--glass-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <h3 style="color: #6366f1; margin-bottom: 1rem;">üìä Budget Overview</h3>
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Total Budget:</span>
                                <strong>$3,000</strong>
                        </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Amount Used:</span>
                                <strong style="color: #10b981;">$1,900</strong>
                        </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Remaining:</span>
                                <strong style="color: #10b981;">$1,100</strong>
                        </div>
                    </div>
                </div>
                    
                    <div style="background: var(--glass-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <h3 style="color: #8b5cf6; margin-bottom: 1rem;">üìà Cost Categories</h3>
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üè® Accommodation:</span>
                                <strong>$800</strong>
                    </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üçΩÔ∏è Food & Dining:</span>
                                <strong>$500</strong>
                </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>üé≠ Activities:</span>
                                <strong>$400</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>üöá Transportation:</span>
                                <strong>$200</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="optimizeBudget()" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    üîß Optimize Budget
                </button>
            </div>
        `;
        
        GlobePilot.showToast('Budget view loaded with current spending analysis', 'success');
    }

    function initializeDocumentsView() {
        const docsContent = document.getElementById('documents');
        if (!docsContent) return;
        
        docsContent.innerHTML = `
            <div style="padding: 2rem;">
                <h2 style="margin-bottom: 2rem; color: #1e293b;">üìã Travel Documents</h2>
                
                <div style="display: grid; gap: 1.5rem;">
                    <div style="background: var(--glass-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <h3 style="color: #10b981; margin-bottom: 1rem;">‚úÖ Required Documents</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #10b981;">‚úì</span>
                                <span>Valid passport (expires after 2026)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #10b981;">‚úì</span>
                                <span>Travel insurance policy</span>
                        </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #10b981;">‚úì</span>
                                <span>Hotel confirmation emails</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #10b981;">‚úì</span>
                                <span>Flight confirmation codes</span>
                        </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--glass-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <h3 style="color: #f59e0b; margin-bottom: 1rem;">üì± Recommended Apps</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>üöá</span>
                                <span>NYC Subway (MTA) app for real-time transit</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>üó∫Ô∏è</span>
                                <span>Google Maps offline download</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>üé≠</span>
                                <span>TodayTix for Broadway show tickets</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>üçΩÔ∏è</span>
                                <span>OpenTable for restaurant reservations</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--glass-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <h3 style="color: #ef4444; margin-bottom: 1rem;">üö® Emergency Contacts</h3>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Emergency Services:</span>
                                <strong>911</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Tourist Hotline:</span>
                                <strong>311</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Embassy/Consulate:</span>
                                <strong>+1-xxx-xxx-xxxx</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        GlobePilot.showToast('Documents checklist loaded with essential travel information', 'success');
    }

    function showValidationPopup() {
        GlobePilot.showToast('‚úÖ Plan Validated: All bookings confirmed, weather checked, routes optimized!', 'success');
    }

    // Data Integration Functions
    function loadBackendData() {
        console.log('üîÑ Loading backend data...');
        
        try {
            // Load structured data if available
            const structuredDataElement = document.getElementById('structured-itinerary-data');
            if (structuredDataElement && structuredDataElement.textContent.trim()) {
                const structuredData = JSON.parse(structuredDataElement.textContent.trim());
                console.log('üìä Structured data found:', structuredData);
                
                if (structuredData.days && Array.isArray(structuredData.days)) {
                    itineraryData = structuredData.days;
                    console.log(`‚úÖ Loaded ${itineraryData.length} days of structured data`);
                    
                    // Update trip overview with real data
                    updateTripOverview(structuredData);
                    
                    // Update weather data if available
                    updateWeatherData(structuredData);
                    
                    // Update budget information
                    updateBudgetData(structuredData);
                    
                    return true;
                }
            }
            
            // Fallback to original itinerary text
            const originalTextElement = document.getElementById('original-itinerary-text');
            if (originalTextElement && originalTextElement.textContent.trim() !== 'No itinerary available') {
                console.log('üìù Using original itinerary text as fallback');
                parseTextItinerary(originalTextElement.textContent);
                return true;
            }
            
            console.log('‚ö†Ô∏è No backend data found, using demo data');
            return false;
            
        } catch (error) {
            console.error('‚ùå Error loading backend data:', error);
            return false;
        }
    }

    function updateTripOverview(data) {
        console.log('üîÑ Updating trip overview...');
        
        try {
            // Update trip statistics
            if (data.trip_overview) {
                const overview = data.trip_overview;
                
                // Update destination
                if (overview.destination) {
                    tripData.destination = overview.destination;
                    updateElementText('.widget-title', `üóΩ ${overview.destination} Adventure`);
                }
                
                // Update duration
                if (overview.duration) {
                    tripData.duration = overview.duration;
                }
                
                                 // Update total cost
                 if (overview.total_cost) {
                     tripData.totalCost = overview.total_cost;
                     updateStatValue('Total Cost', `¬±$${overview.total_cost.toLocaleString()}`);
                 }
            }
            
            // Update activity count
            if (data.days) {
                let totalActivities = 0;
                data.days.forEach(day => {
                    if (day.activities) totalActivities += day.activities.length;
                });
                tripData.activities = totalActivities;
                updateStatValue('Activities', totalActivities);
            }
            
            console.log('‚úÖ Trip overview updated');
            
        } catch (error) {
            console.error('‚ùå Error updating trip overview:', error);
        }
    }

    function updateWeatherData(data) {

    }



    function updateBudgetData(data) {
        console.log('üí∞ Updating budget data...');
        
        try {
            let totalCost = 0;
            
            // Calculate total from days
            if (data.days) {
                data.days.forEach(day => {
                    if (day.total_cost) {
                        totalCost += day.total_cost;
                    } else if (day.activities) {
                        day.activities.forEach(activity => {
                            if (activity.cost && typeof activity.cost === 'number') {
                                totalCost += activity.cost;
                            }
                        });
                    }
                });
            }
            
            // Use trip overview total if available
            if (data.trip_overview && data.trip_overview.total_cost) {
                totalCost = data.trip_overview.total_cost;
            }
            
                         if (totalCost > 0) {
                 tripData.totalCost = totalCost;
                 updateStatValue('Total Cost', `¬±$${totalCost.toLocaleString()}`);
                 
                 // Update budget indicator
                 const budgetUsage = Math.round((totalCost / tripData.budget) * 100);
                 updateBudgetIndicator(budgetUsage, totalCost);
             }
            
            console.log('‚úÖ Budget data updated');
            
        } catch (error) {
            console.error('‚ùå Error updating budget data:', error);
        }
    }

    function updateBudgetIndicator(percentage, totalCost) {
        const budgetAmount = document.querySelector('.budget-amount');
        const budgetCircle = document.querySelector('.budget-circle');
        const overBudgetText = document.querySelector('.widget-actions > div > div');
        
        if (budgetAmount) {
            budgetAmount.textContent = `${percentage}%`;
        }
        
        if (budgetCircle && percentage > 100) {
            const overAmount = totalCost - tripData.budget;
            budgetCircle.style.background = `conic-gradient(#ef4444 0deg ${Math.min(360, percentage * 3.6)}deg, #e2e8f0 ${Math.min(360, percentage * 3.6)}deg 360deg)`;
            
            if (overBudgetText) {
                overBudgetText.innerHTML = `
                    <div style="font-weight: 700; color: #ef4444; font-size: 1.125rem;">$${overAmount.toLocaleString()} Over Budget</div>
                    <div style="color: #64748b; font-size: 0.875rem;">$${totalCost.toLocaleString()} of $${tripData.budget.toLocaleString()} budget used</div>
                `;
            }
        }
    }

    function updateStatValue(label, value) {
        const stats = document.querySelectorAll('.trip-stat');
        stats.forEach(stat => {
            const labelElement = stat.querySelector('.trip-stat-label');
            const valueElement = stat.querySelector('.trip-stat-value');
            if (labelElement && labelElement.textContent === label && valueElement) {
                valueElement.textContent = value;
            }
        });
    }

    function updateElementText(selector, text) {
        const element = document.querySelector(selector);
        if (element) {
            element.textContent = text;
        }
    }

    function parseTextItinerary(text) {
        console.log('üìù Parsing text itinerary...');
        
        try {
            // Simple parsing logic for text-based itinerary
            const days = text.split(/Day \d+|DAY \d+/i).filter(day => day.trim());
            
            itineraryData = days.slice(1).map((day, index) => ({
                day_number: index + 1,
                date: `Aug ${20 + index}`,
                title: `Day ${index + 1}`,
                summary: day.substring(0, 100) + '...',
                activities: extractActivitiesFromText(day)
            }));
            
            console.log(`‚úÖ Parsed ${itineraryData.length} days from text`);
            
        } catch (error) {
            console.error('‚ùå Error parsing text itinerary:', error);
        }
    }

    function extractActivitiesFromText(dayText) {
        // Simple extraction logic
        const lines = dayText.split('\n').filter(line => line.trim());
        return lines.slice(0, 5).map((line, index) => ({
            time: `${9 + index * 2}:00`,
            activity: line.trim(),
            location: 'New York City',
            cost: 50 + index * 20
        }));
    }

    function displayItineraryData() {
        console.log('üìÖ Displaying itinerary data...');
        
        const itineraryContent = document.getElementById('itineraryContent');
        if (!itineraryContent || !itineraryData.length) {
            console.log('‚ö†Ô∏è No itinerary content or data found');
            return;
        }
        
        try {
            // Display first day by default
            displayDay(1);
            console.log('‚úÖ Itinerary data displayed');
            
        } catch (error) {
            console.error('‚ùå Error displaying itinerary data:', error);
        }
    }

    function displayDay(dayNumber) {
        const dayData = itineraryData.find(day => day.day_number === dayNumber);
        const itineraryContent = document.getElementById('itineraryContent');
        
        if (!dayData || !itineraryContent) return;
        
        currentDay = dayNumber;
        
        // Create enhanced timeline content
        itineraryContent.innerHTML = `
            <div class="day-content">
                <div class="route-summary">
                    <div class="route-stats">
                        <div class="route-stat">
                            <div class="route-stat-value">${dayData.activities ? dayData.activities.length : 0}</div>
                            <div class="route-stat-label">STOPS</div>
                        </div>
                        <div class="route-stat">
                            <div class="route-stat-value">4.0 mi</div>
                            <div class="route-stat-label">TOTAL DISTANCE</div>
                        </div>
                        <div class="route-stat">
                            <div class="route-stat-value">60 min</div>
                            <div class="route-stat-label">WALKING TIME</div>
                        </div>
                    </div>
                </div>
                
                <div class="activity-timeline">
                    <div class="timeline-container">
                        <div class="timeline-spine"></div>
                        ${dayData.activities ? dayData.activities.map((activity, index) => createActivityHTML(activity, index, dayData.activities)).join('') : ''}
                    </div>
                </div>
            </div>
        `;
    }

    function createActivityHTML(activity, index, allActivities) {
        const activityType = determineActivityType(activity.activity || activity.name || '');
        const cost = activity.cost || 0;
        const costText = typeof cost === 'number' ? `$${cost}` : cost;
        const connectionType = getConnectionType(activity, index, allActivities);
        const connectionIcon = getConnectionIcon(connectionType);
        
        return `
            <div class="activity-item ${activityType}" onclick="highlightActivity(${index})">
                <div class="activity-header">
                    <div class="activity-type-badge ${activityType}">${activityType}</div>
                    <div class="activity-time">${activity.time || '9:00 AM'}</div>
                </div>
                <div class="activity-title">${activity.activity || activity.name || 'Activity'}</div>
                <div class="activity-details">${activity.location || activity.address || 'Location TBD'}</div>
                <div class="activity-meta">
                    <div class="activity-meta-item cost">üí∞ ${costText}</div>
                    <div class="activity-meta-item">‚è±Ô∏è ${activity.duration || '1-2 hours'}</div>
                    ${activity.phone ? `<div class="activity-meta-item">üìû ${activity.phone}</div>` : ''}
                    ${activity.website_url ? `<div class="activity-meta-item">üåê <a href="${activity.website_url}" target="_blank">Website</a></div>` : ''}
            </div>
                ${index < allActivities.length - 1 ? `
                    <div class="connection-line ${connectionType}">
                        <div class="connection-icon ${connectionType}" onclick="showConnectionDetails('${connectionType}', ${index})">
                            ${connectionIcon}
                            <div class="connection-tooltip">
                                ${getConnectionTooltip(connectionType, index)}
                            </div>
                        </div>
                        <div class="connection-details">
                            <div class="connection-detail-title">${connectionType.charAt(0).toUpperCase() + connectionType.slice(1)} Route</div>
                            <div class="connection-detail-item">
                                <span>Time:</span>
                                <span class="connection-detail-value">${getConnectionTime(connectionType)}</span>
                            </div>
                            <div class="connection-detail-item">
                                <span>Cost:</span>
                                <span class="connection-detail-value">${getConnectionCost(connectionType)}</span>
                            </div>
                            <div class="connection-detail-item">
                                <span>Distance:</span>
                                <span class="connection-detail-value">${getConnectionDistance(connectionType)}</span>
                            </div>
                        </div>
                    </div>
                ` : ''}
        </div>
    `;
    }

    function determineActivityType(activityName) {
        const name = activityName.toLowerCase();
        if (name.includes('flight') || name.includes('airport')) return 'flight';
        if (name.includes('hotel') || name.includes('check')) return 'hotel';
        if (name.includes('dinner') || name.includes('lunch') || name.includes('breakfast') || name.includes('restaurant')) return 'meal';
        if (name.includes('museum') || name.includes('park') || name.includes('tour')) return 'attraction';
        if (name.includes('shop') || name.includes('market')) return 'attraction';
        if (name.includes('transfer') || name.includes('taxi') || name.includes('subway') || name.includes('bus')) return 'transport';
        return 'attraction';
    }

    function getConnectionType(activity, index, allActivities) {
        if (index >= allActivities.length - 1) return 'none';
        
        const currentActivity = activity.activity || activity.name || '';
        const nextActivity = allActivities[index + 1]?.activity || allActivities[index + 1]?.name || '';
        
        // Determine connection based on activity types and keywords
        if (currentActivity.toLowerCase().includes('hotel') || nextActivity.toLowerCase().includes('hotel')) return 'taxi';
        if (currentActivity.toLowerCase().includes('airport') || nextActivity.toLowerCase().includes('airport')) return 'taxi';
        if (currentActivity.toLowerCase().includes('subway') || nextActivity.toLowerCase().includes('subway')) return 'subway';
        
        // Check distance/time to determine connection type
        const currentLocation = activity.location || activity.address || '';
        const nextLocation = allActivities[index + 1]?.location || allActivities[index + 1]?.address || '';
        
        if (currentLocation.includes('Central Park') && nextLocation.includes('Central Park')) return 'walking';
        if (currentLocation.includes('Times Square') && nextLocation.includes('Theater District')) return 'walking';
        
        // Default connections based on typical NYC travel patterns
        const randomConnections = ['walking', 'subway', 'taxi'];
        return randomConnections[index % 3];
    }

    function getConnectionIcon(connectionType) {
        switch (connectionType) {
            case 'walking': return 'üö∂‚Äç‚ôÇÔ∏è';
            case 'taxi': return 'üöï';
            case 'subway': return 'üöá';
            case 'bus': return 'üöå';
            default: return '‚û°Ô∏è';
        }
    }

    function getConnectionTooltip(connectionType, index) {
        const tooltips = {
            walking: 'Walk ‚Ä¢ Fresh air & city views',
            taxi: 'Taxi ‚Ä¢ Quick & comfortable',
            subway: 'Subway ‚Ä¢ Fast & efficient',
            bus: 'Bus ‚Ä¢ Scenic route'
        };
        return tooltips[connectionType] || 'Transportation';
    }

    function getConnectionTime(connectionType) {
        const times = {
            walking: '12-18 min',
            taxi: '8-15 min',
            subway: '10-12 min',
            bus: '15-25 min'
        };
        return times[connectionType] || '15 min';
    }

    function getConnectionCost(connectionType) {
        const costs = {
            walking: 'Free',
            taxi: '$15-25',
            subway: '$2.90',
            bus: '$2.90'
        };
        return costs[connectionType] || '$5';
    }

    function getConnectionDistance(connectionType) {
        const distances = {
            walking: '0.5-1.2 mi',
            taxi: '0.8-2.0 mi',
            subway: '1.0-3.0 mi',
            bus: '1.2-2.5 mi'
        };
        return distances[connectionType] || '1 mi';
    }

    function showConnectionDetails(connectionType, index) {
        const connectionDetails = {
            walking: 'Enjoy a scenic walk through NYC streets with plenty of photo opportunities and local atmosphere.',
            taxi: 'Quick and comfortable taxi ride through the bustling streets of New York City.',
            subway: 'Efficient subway connection on the NYC transit system - download the app for real-time updates.',
            bus: 'Scenic bus route that offers great city views and connects major neighborhoods.'
        };
        
        const detail = connectionDetails[connectionType] || 'Transportation connection';
        const time = getConnectionTime(connectionType);
        const cost = getConnectionCost(connectionType);
        
        GlobePilot.showToast(`${detail}\n‚è±Ô∏è ${time} ‚Ä¢ üí∞ ${cost}`, 'success');
    }

    function highlightActivity(index) {
        // Remove previous highlights
        document.querySelectorAll('.activity-item').forEach(item => {
            item.classList.remove('highlighted');
        });
        
        // Highlight selected activity
        const activities = document.querySelectorAll('.activity-item');
        if (activities[index]) {
            activities[index].classList.add('highlighted');
        }
    }

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content-item');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.getAttribute('data-tab');

            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));

            btn.classList.add('active');
            const targetContent = document.getElementById(tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }

            currentTab = tabId;
        });
    });

    // Search functionality
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm) {
                GlobePilot.showToast(`Searching for "${searchTerm}"...`, 'success');
            }
        });
    }

    // Google Maps Integration
    function initializeItineraryWidget() {
        console.log('üó∫Ô∏è Initializing itinerary widget...');
        
        // Load and display data
        const hasData = loadBackendData();
        displayItineraryData();
        
        // Initialize map if Google Maps is available
        if (typeof google !== 'undefined' && google.maps) {
            initializeGoogleMap();
    } else {
            console.log('‚ö†Ô∏è Google Maps not available, skipping map initialization');
        }
        
        console.log('‚úÖ Itinerary widget initialized');
    }

    function initializeGoogleMap() {
        const mapElement = document.getElementById('itinerary-map-integrated');
        if (!mapElement) {
            console.log('‚ö†Ô∏è Map element not found');
            return;
        }
        
        try {
            mapIntegrated = new google.maps.Map(mapElement, {
                center: { lat: 40.7505, lng: -73.9934 }, // NYC center
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP }
            });
            
            console.log('‚úÖ Google Map initialized');
            
        } catch (error) {
            console.error('‚ùå Error initializing Google Map:', error);
        }
    }

    // Make initializeItineraryWidget globally accessible for Google Maps callback
    window.initializeItineraryWidget = initializeItineraryWidget;

    // Enhanced Interactive Features - Keyboard Navigation & URL Support
    function initializeURLNavigation() {
        // Handle initial hash
        const hash = window.location.hash.substring(1);
        if (hash && ['itinerary', 'map', 'budget', 'documents'].includes(hash)) {
            switchTab(hash);
        }
        
        // Handle hash changes
        window.addEventListener('hashchange', () => {
            const newHash = window.location.hash.substring(1);
            if (newHash && ['itinerary', 'map', 'budget', 'documents'].includes(newHash)) {
                switchTab(newHash);
            }
        });
    }

    // Add CSS for enhanced interactions
    function addEnhancedStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .search-highlight {
                background: #fef3c7;
                color: #92400e;
                padding: 0.125rem 0.25rem;
                border-radius: 4px;
                font-weight: 600;
            }
            
            .search-results {
                animation: slideIn 0.3s ease;
            }
            
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .tab-content-item {
                display: none;
                animation: fadeIn 0.3s ease;
            }

            .tab-content-item.active {
                display: block;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .activity-item {
                scroll-margin-top: 2rem;
            }
        `;
        document.head.appendChild(style);
    }

    // Keyboard Navigation Support
    function initializeKeyboardNavigation() {
        document.addEventListener('keydown', (event) => {
            // Tab navigation with keyboard
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case '1':
                        event.preventDefault();
                        switchTab('itinerary');
                        break;
                    case '2':
                        event.preventDefault();
                        switchTab('map');
                        break;
                    case '3':
                        event.preventDefault();
                        switchTab('budget');
                        break;
                    case '4':
                        event.preventDefault();
                        switchTab('documents');
                        break;
                    case 'f':
                        event.preventDefault();
                        document.querySelector('.search-input')?.focus();
                        break;
                }
            }

            // Activity navigation with arrow keys
            if (AppState.currentTab === 'itinerary') {
                const activities = document.querySelectorAll('.activity-item');
                const currentIndex = AppState.selectedActivity || 0;
                
                switch (event.key) {
                    case 'ArrowDown':
                        event.preventDefault();
                        if (currentIndex < activities.length - 1) {
                            highlightActivity(currentIndex + 1);
                        }
                        break;
                    case 'ArrowUp':
                        event.preventDefault();
                        if (currentIndex > 0) {
                            highlightActivity(currentIndex - 1);
                        }
                        break;
                    case 'Enter':
                        if (activities[currentIndex]) {
                            activities[currentIndex].click();
                        }
                        break;
                    case 'Escape':
                        // Clear search and filters
                        const searchInput = document.querySelector('.search-input');
                        if (searchInput) {
                            searchInput.value = '';
                            showAllActivities();
                        }
                        break;
                }
            }
        });
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM loaded, initializing...');
        
        // Initialize immediately if Google Maps is already loaded
        if (typeof google !== 'undefined' && google.maps) {
            initializeItineraryWidget();
        } else {
            // Wait for Google Maps to load
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.maps) {
                    initializeItineraryWidget();
                } else {
                    // Initialize without maps
                    console.log('‚ö†Ô∏è Google Maps not loaded, initializing without map');
                    const hasData = loadBackendData();
                    displayItineraryData();
                }
            }, 2000);
        }
        
        // Initialize enhanced interactive features
        addEnhancedStyles();
        initializeURLNavigation();
        initializeKeyboardNavigation();
        
        // Initialize state management
        console.log('üéØ App State initialized:', AppState);
        
        // Create debounced search function
        window.debouncedSearch = debounce(searchActivities, 300);
        
        // Welcome message with shortcuts
        setTimeout(() => {
            GlobePilot.showToast('üéâ Welcome to Enhanced GlobePiloT!\n\n‚å®Ô∏è Keyboard shortcuts:\n‚Ä¢ Ctrl/Cmd + 1-4: Switch tabs\n‚Ä¢ Ctrl/Cmd + F: Focus search\n‚Ä¢ ‚Üë‚Üì arrows: Navigate activities\n‚Ä¢ ESC: Clear search', 'success');
        }, 1000);
    });

    // Additional CSS for activity styling
    const activityStyles = `
        <style>
            .route-summary {
                background: white;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                border: 1px solid #e2e8f0;
            }
            
            .route-stats {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                text-align: center;
            }
            
            .route-stat {
                padding: 10px;
                background: #f8fafc;
                border-radius: 8px;
            }
            
            .route-stat-value {
                font-size: 1.2rem;
                font-weight: 700;
                color: #1e293b;
            }
            
            .route-stat-label {
                font-size: 0.8rem;
                color: #64748b;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .activity-list {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            
            .activity-item {
                background: #f8fafc;
                border-radius: 16px;
                padding: 20px;
                border-left: 4px solid;
                transition: all 0.3s ease;
                cursor: pointer;
                position: relative;
            }
            
            .activity-item:hover {
                transform: translateX(8px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }
            
            .activity-item.highlighted {
                background: #fef3c7;
                transform: translateX(8px);
                box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
            }
            
            .activity-item.meal { border-left-color: #f59e0b; }
            .activity-item.attraction { border-left-color: #10b981; }
            .activity-item.transport { border-left-color: #6366f1; }
            .activity-item.accommodation { border-left-color: #06b6d4; }
            .activity-item.shopping { border-left-color: #ec4899; }
            
            .activity-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
            }
            
            .activity-type {
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                opacity: 0.7;
            }
            
            .activity-time {
                font-size: 0.9rem;
                color: #4f46e5;
                font-weight: 500;
            }
            
            .activity-name {
                font-size: 1.1rem;
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 6px;
            }
            
            .activity-details {
                font-size: 0.9rem;
                color: #64748b;
                line-height: 1.4;
            }
        </style>
    `;
    
    // Add styles to head
    document.head.insertAdjacentHTML('beforeend', activityStyles);
  </script>

<!-- External JavaScript for better caching and performance -->
<script src="{{ asset_url('js/results.js') }}" defer></script>

{% endblock %} 